## Третий блок. Упражнение 7

### Упражнение 7. Обобщённый reply

Каждый раз при добавлении новой стратегии приходилось переписывать ***reply***. Можно переписать его раз и навсегда, создав обобщённую версию ***reply-v2***, которая будет работать с любым подаваемым ему на вход вектором стратегий. Удобство обобщённого ***reply-v2*** состоит в том, что при изменении стратегий построения ответных реплик будет достаточно менять сами данные о стратегиях, но не управляющий механизм.

Этот универсальный механизм состоит в следующем: во-первых, строится вектор стратегий, применимых в текущей ситуации; во-вторых, если в построенном векторе больше одной стратегии, то выбирается одна из них; в-третьих, выбранная стратегия применяется и её результат будет ответной репликой.

На вход механизма подаётся вектор, в каждом элементе которого хранятся сведения об одной из стратегий «Доктора». Каждой стратегии «Доктора» соответствует единственный элемент вектора. В этом элементе находятся:
- функция-чеккер стратегии -- функция, которая по реплике пользователя, по истории реплик пользователя, по, возможно, другим параметрам возвращает `#f`, только если стратегия не применима, и не `#f` -- иначе (*внимание! должна храниться именно функция, а не список символов и т. п.!*);
- вес стратегии -- ненулевое натуральное число, которое будет использовано при выборе одной из применимых стратегий (чем больше вес, тем выше вероятность применения стратегии, например, если есть применимые стратегии с весами 2, 3, 1, то первая будет выбрана с вероятностью 1/3, вторая -- с вероятностью 1/2, третья -- с вероятностью 1/6);
- функция-тело стратегии -- функция, которая по реплике пользователя, по истории реплик пользователя, по, возможно, другим параметрам строит ответную реплику (*внимание! должна храниться именно функция!*).

Например, для стратегии "hedge"
- функция-чеккер -- это функция всегда возвращающая `#t` (или другое значение не равное `#f`);
- вес этой стратегии = 1 (самый малый);
- функция-тело -- функция ***hedge-answer***.

Выполняя упражнение 7, следует написать ***reply-v2***, добавив ему параметр -- вектор с данными о стратегиях построения реплик. Все стратегии ответов, имеющиеся в программе должны быть представлены в этом векторе. Каких-либо способов построения ответов вне вектора стратегий быть не должно. Вектор стратегий не зависит от реплик пользователей и его значение не должно вычисляться в программе более чем один раз. Для элементов вектора стратегий следует самостоятельно выбрать внутреннее представление и явно реализовать функции работы с ним: конструктор, селекторы, чеккеры. Так как речь снова идёт об обработке списков/векторов, пишите код с использованием уместных функций высшего порядка (***map***, ***foldl***, ***foldr***, ***filter***, ***andmap***, ***ormap*** ... и/или их векторых аналогов). Назначая веса стратегиям, используйте разные значения веса, чтобы взвешенный поиск не превращался в случайный -- ***pick-random-vector***. Следует реализовать аналог функции ***pick-random-vector*** -- функцию ***pick-random-vector-with-weight***, которая получает вектор элементов, имеющих веса, -- в частности, это может быть наш вектор стратегий, в котором оставлены только применимые в текущий момент стратегии, -- а также функцию-селектор, которая возвращает вес элемента вектора. Функция ***pick-random-vector-with-weight*** выбирает случайный элемент с учётом весов. Реализация должна быть эффективной. Рекомендуется перед составлением кода «геометрически» решить задачу, т. е. рассмотреть случайный бросок точки в составной отрезок (длина части отрезка = весу соответствующего элемента списка) и выбор части, в которую попала точка. Используйте метафункции для обработки векторов. Используйте ***call/cc*** для досрочного возвращения результата в лучшем случае.